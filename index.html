<!DOCTYPE html>
<html>
	<head>
	    <title>Socket.io Expo</title>
	    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	</head>
	<body>
		<script>
		    window.WebSocket = window.WebSocket || window.MozWebSocket;

		    var connection = new WebSocket('ws://192.168.2.167:3000');
		    current_id = '';

		    connection.onopen = function () {
		        alert('Your connection is open and ready to use!');
		    };

		    connection.onerror = function (error) {
		        alert('You meet some error!')
		    };

		    connection.onmessage = function (message) {
		    	var msg = JSON.parse(message.data)

		    	if(msg.type === 'fight_win'){
		    		$("#fight_notice").text('Yeah you win!!');

		    	} else if (msg.type === 'current_info'){
		    		$('#user_notice').text('your id is:' + msg.data.id);
		    		current_id = msg.data.id;

		    	} else if (msg.type === 'leave_success'){
		    		alert(msg.data);
		    		$("#wait_fight").hide();
		    		$("#btn_fight").attr('disabled', false);

		    	} else if (msg.type === 'find_user'){
		    		$("#oppo_info").show();
		    		$("#fight_notice").text(msg.data.text + '. and the user is:' + msg.data.oppo_data.name + '. and the room id is' + msg.data.room);
		    		$("#oppo_user_sex").text('his sex is:' + msg.data.oppo_data.sex);
		    		$("#oppo_user_iq").text('his iq is:' + msg.data.oppo_data.iq);
		    		$("#wait_fight").hide();
		    		

		    	} else if (msg.type === 'force_leave'){
		    		alert(msg.data);
		    		$("#wait_fight").hide();
		    		$("#btn_fight").attr('disabled', false);
		    		$("#fight_notice").text('');
		    		$("#oppo_info").hide();
		    		$("#battle_info").hide();

		    	} else if (msg.type === 'another_leave'){
		    		alert(msg.data);
		    		$("#wait_fight").hide();
		    		$("#btn_fight").attr('disabled', false);
		    		$("#fight_notice").text('');
		    		$("#oppo_info").hide();
		    		$("#battle_info").hide();

		    	} else if (msg.type === 'question'){
		    		if(msg.data.ans === current_id){
		    			// you can use the button
						// alert('you answer!')
						$("#battle_info").show();
						$("#question").text(msg.data.q);
						$("#btn_answer_a").text(msg.data.h[0]).prop('disabled', false);
						$("#btn_answer_b").text(msg.data.h[1]).prop('disabled', false);
						$("#btn_answer_c").text(msg.data.h[2]).prop('disabled', false);
						$("#btn_answer_d").text(msg.data.h[3]).prop('disabled', false);
		    		}else{
		    			// you can only see!
		    			// alert('you wait!')
		    			$("#battle_info").show();
						$("#question").text(msg.data.q);
						$("#btn_answer_a").text(msg.data.h[0]).prop('disabled', true);
						$("#btn_answer_b").text(msg.data.h[1]).prop('disabled', true);
						$("#btn_answer_c").text(msg.data.h[2]).prop('disabled', true);
						$("#btn_answer_d").text(msg.data.h[3]).prop('disabled', true);
		    		}
		    	
		    	} else if (msg.type === 'answer_status'){
		    		alert('the people select: ' + msg.data);

		    	} else if (msg.type === 'end_fight'){
		    		alert(msg.data['text']);

		    		// change jquery status
		    		$("#wait_fight").hide();
		    		$("#btn_fight").attr('disabled', false);
		    		$("#fight_notice").text('');
		    		$("#oppo_info").hide();
		    		$("#battle_info").hide();
		    	}

		        $("#show").text(msg.data);
		    };

		    $(document).ready(function(){
		    	$("#btn_fight").click(function(){
		    		var send_info = {
		    			'type': 'waiting_fight',
		    			'data': ''
		    		}
		    		connection.send(JSON.stringify(send_info));
		    		$("#wait_fight").show();
		    		$("#btn_fight").attr('disabled', true);
		    	})

		    	$("#leave_waiting_btn").click(function(){
		    		var send_info = {
		    			type: 'leave_waiting',
		    			data: ''
		    		}
		    		connection.send(JSON.stringify(send_info));
		    	})

		    	$("#leave_fight_btn").click(function(){
		    		var send_info = {
		    			type: 'leave_fight',
		    			data: ''
		    		}
		    		connection.send(JSON.stringify(send_info));
		    	})

		    	$(".answer").click(function(){
		    		var ans = $(this).text();
		    		var send_info = {
		    			type: 'send_answer',
		    			data: {
		    				answer: ans
		    			}
		    		}
		    		connection.send(JSON.stringify(send_info));
		    	})
		    })

		</script>
		<center>
			<div id='select_mode'>
				<button id='btn_fight'>Fight Mode!</button>
			</div>
			<br />

			<p id='user_notice'></p>

			<div id='wait_fight' style='display:none'>
				<p>System searching man for you!</p>
				<br />
				<button id='leave_waiting_btn'>Leave Waiting</button>
			</div>
			<br />
			============================================

			
			<div id='oppo_info' style='display:none'>
				<p id='oppo_user_sex'></p>
				<p id='oppo_user_iq'></p>
				<p id='fight_notice'></p>
				<button id='leave_fight_btn'>Leave Fight</button>
			</div>
			<br />

			===========================================
			<div id='battle_info' style='display:none'>
				<p id='question'></p><br />
				<button id='btn_answer_a' class="answer"></button><br />
				<button id='btn_answer_b' class="answer"></button><br />
				<button id='btn_answer_c' class="answer"></button><br />
				<button id='btn_answer_d' class="answer"></button><br />
			</div>

		</center>
	</body>
</html>